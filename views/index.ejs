<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WireGuard Manager</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="android-chrome" href="/favicon/android-chrome-192x192.png" />
    <link rel="android-chrome" href="/favicon/android-chrome-512x512.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* ── Toggle switch: smooth transition, NO flash ── */
        .toggle-btn {
            transition: background-color 0.25s ease;
        }

        .toggle-knob {
            transition: transform 0.25s ease;
        }

        /* ── Row delete: opacity+slide via CSS transition, NO keyframe flash ── */
        .row-removing {
            transition: opacity 0.35s ease, transform 0.35s ease, max-height 0.4s ease, padding 0.35s ease;
            overflow: hidden;
            max-height: 200px;
        }

        .row-removing.out {
            opacity: 0;
            transform: translateX(16px);
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        /* ── Modal: smooth fade-in/out, NO flash ── */
        .modal-wrap {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-wrap.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-box {
            transform: translateY(-10px) scale(0.98);
            opacity: 0;
            transition: transform 0.22s ease, opacity 0.22s ease;
        }

        .modal-wrap.visible .modal-box {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        /* ── Inline progress bar: linear movement, NO rotation/flash ── */
        .progress-bar-wrap {
            height: 3px;
            background: #e0e7ff;
            border-radius: 99px;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.15s ease;
            margin-top: 6px;
        }

        .progress-bar-wrap.active {
            opacity: 1;
        }

        .progress-bar-inner {
            height: 100%;
            width: 0%;
            background: #6366f1;
            border-radius: 99px;
        }

        /* ── Dot-ellipsis loading (safe, no spin/flash) ── */
        .dot-pulse::after {
            content: '';
            animation: dots 1.4s steps(4, end) infinite;
        }

        @keyframes dots {
            0% {
                content: '';
            }

            25% {
                content: '.';
            }

            50% {
                content: '..';
            }

            75% {
                content: '...';
            }
        }

        /* ── Button loading: dim, no icon change ── */
        .btn-loading {
            opacity: 0.55 !important;
            pointer-events: none !important;
        }

        /* ── Toast: slide-in from top-right, NO flash ── */
        #toast {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            padding: 0.7rem 1.1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.12);
            opacity: 0;
            transform: translateY(-8px);
            transition: opacity 0.22s ease, transform 0.22s ease;
            pointer-events: none;
            max-width: 320px;
        }

        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        #toast.success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        #toast.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        #toast.info {
            background: #eef2ff;
            color: #3730a3;
            border: 1px solid #a5b4fc;
        }

        /* ── QR image: fade in when loaded ── */
        #qrImage {
            opacity: 0;
            transition: opacity 0.3s ease;
            display: block;
            margin: 0 auto;
        }

        #qrImage.loaded {
            opacity: 1;
        }

        /* ── Swal: disable ALL its built-in animations (they can flash) ── */
        .swal2-show,
        .swal2-hide,
        .swal2-backdrop-show,
        .swal2-backdrop-hide {
            animation: none !important;
        }

        .swal2-popup {
            animation: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Toast notification -->
    <div id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fa-solid fa-network-wired text-2xl"></i>
                <h1 class="text-xl font-bold">WireGuard Manager</h1>
            </div>
            <div class="text-sm bg-indigo-700 px-3 py-1 rounded">
                Server: <%= server.host %>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">

        <!-- Error Banner -->
        <% if (error) { %>
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded shadow" role="alert">
                <p class="font-bold">Error Connection</p>
                <p>
                    <%= error %>
                </p>
            </div>
            <% } %>

                <!-- Header: Counters + Add Button -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex space-x-4">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <span class="text-gray-500 text-sm">Total Peers</span>
                            <p class="counter-total text-2xl font-bold text-gray-800">
                                <%= peers.length %>
                            </p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                            <span class="text-gray-500 text-sm">Active</span>
                            <p class="counter-active text-2xl font-bold text-green-600">
                                <%= peers.filter(p=> p.disabled === 'false').length %>
                            </p>
                        </div>
                    </div>
                    <button onclick="openModal()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded shadow transition-colors flex items-center gap-2">
                        <i class="fas fa-plus"></i> Add Peer
                    </button>
                </div>

                <!-- Peers Table -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Name</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    IPv4</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    IPv6</th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Traffic (Tx/Rx)</th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="peersTableBody">
                            <% peers.forEach(peer=> {
                                const isActive = peer.disabled === 'false';
                                const txMB = (parseInt(peer['tx-byte'] || 0) / 1024 / 1024).toFixed(2);
                                const rxMB = (parseInt(peer['rx-byte'] || 0) / 1024 / 1024).toFixed(2);
                                const hasPk = peer.privkey && peer.privkey !== 'null' && peer.privkey !== 'undefined';
                                const hasIpv6 = peer.ipv6 && peer.ipv6 !== '-';
                                const canConfig = hasPk && hasIpv6;
                                %>
                                <tr id="row-<%= peer['.id'] %>" data-active="<%= isActive %>"
                                    data-name="<%= peer.name %>" data-privkey="<%= peer.privkey %>"
                                    data-ipv4="<%= peer.ipv4 %>" data-ipv6="<%= peer.ipv6 %>"
                                    class="hover:bg-gray-50 transition-colors">

                                    <!-- Toggle -->
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button onclick="togglePeer(this, '<%= peer['.id'] %>')"
                                            id="toggle-<%= peer['.id'] %>" aria-label="Toggle peer <%= peer.name %>"
                                            aria-pressed="<%= isActive %>"
                                            class="toggle-btn relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-1 <%= isActive ? 'bg-green-500' : 'bg-gray-200' %>">
                                            <span
                                                class="toggle-knob pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow ring-0 <%= isActive ? 'translate-x-5' : 'translate-x-0' %>"></span>
                                        </button>
                                    </td>

                                    <!-- Name -->
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">
                                            <%= peer.name || '(no name)' %>
                                        </div>
                                        <div class="text-xs text-gray-400">PK: <%= peer['public-key'].substring(0, 8) %>
                                                ...</div>
                                    </td>

                                    <!-- IPv4 -->
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-700">
                                        <%= peer.ipv4 %>
                                    </td>

                                    <!-- IPv6 -->
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">
                                        <%= peer.ipv6 %>
                                    </td>

                                    <!-- Traffic -->
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <div><i class="fas fa-arrow-up text-green-500 mr-1"></i>
                                            <%= txMB %> MB
                                        </div>
                                        <div><i class="fas fa-arrow-down text-blue-500 mr-1"></i>
                                            <%= rxMB %> MB
                                        </div>
                                    </td>

                                    <!-- Actions -->
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="inline-flex items-center gap-2">

                                            <!-- Download .conf langsung -->
                                            <button id="dl-<%= peer['.id'] %>"
                                                onclick="<%= canConfig ? 'downloadConfigDirect(\'' + peer['.id'] + '\')' : 'return false' %>"
                                                title="<%= !hasPk ? 'Private key tidak tersedia (dibuat manual)' : !hasIpv6 ? 'IPv6 tidak tersedia' : 'Download .conf' %>"
                                                class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors
                                        <%= canConfig ? 'text-green-600 hover:text-green-800 hover:bg-green-100 bg-green-50' : 'text-gray-300 bg-gray-50 cursor-not-allowed' %>">
                                                <i class="fas fa-download text-sm"></i>
                                            </button>

                                            <!-- QR Code -->
                                            <button id="qr-<%= peer['.id'] %>"
                                                onclick="<%= canConfig ? 'showQR(\'' + peer['.id'] + '\')' : 'return false' %>"
                                                title="<%= !hasPk ? 'Private key tidak tersedia (dibuat manual)' : !hasIpv6 ? 'IPv6 tidak tersedia' : 'Tampilkan QR Code' %>"
                                                class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors
                                        <%= canConfig ? 'text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 bg-indigo-50' : 'text-gray-300 bg-gray-50 cursor-not-allowed' %>">
                                                <i class="fas fa-qrcode text-sm"></i>
                                            </button>

                                            <!-- Delete -->
                                            <button id="del-<%= peer['.id'] %>"
                                                onclick="deletePeer('<%= peer['.id'] %>')" title="Hapus peer"
                                                class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors text-red-500 hover:text-red-700 hover:bg-red-100 bg-red-50">
                                                <i class="fas fa-trash text-sm"></i>
                                            </button>

                                        </div>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>

                    <% if (peers.length===0 && !error) { %>
                        <div id="emptyMsg" class="p-8 text-center text-gray-500">No peers found.</div>
                        <% } %>
                </div>

    </div><!-- /container -->


    <!-- ══════════════════════════════════════════════════════════════════
         Add Peer Modal — smooth fade, NO flash
    ══════════════════════════════════════════════════════════════════ -->
    <div id="addModal" class="modal-wrap fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-40"
        role="dialog" aria-modal="true" aria-labelledby="addModalTitle" onclick="handleModalBackdrop(event)">

        <div class="modal-box relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
            onclick="event.stopPropagation()">

            <div class="flex justify-between items-center mb-4">
                <h3 id="addModalTitle" class="text-lg font-medium text-gray-900">Add New Peer</h3>
                <button type="button" id="regenBtn" onclick="fetchSuggest()" class="text-xs text-indigo-600 hover:text-indigo-800 flex items-center gap-1
                           border border-indigo-200 px-2 py-1 rounded hover:bg-indigo-50 transition-colors">
                    <i class="fas fa-sync-alt"></i>
                    <span id="regenLabel">Regenerate</span>
                </button>
            </div>

            <form id="addForm" novalidate>

                <!-- Name -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-1" for="fieldName">
                        Name <span class="text-red-500">*</span>
                        <span class="font-normal text-gray-400 ml-1">(auto-generated)</span>
                    </label>
                    <input type="text" id="fieldName" name="name" required autocomplete="off" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700
                               focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-shadow">
                </div>

                <!-- IPv4 -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-1" for="fieldIPv4">
                        IPv4 <span class="text-red-500">*</span>
                        <span class="font-normal text-gray-400 ml-1">(auto)</span>
                    </label>
                    <input type="text" id="fieldIPv4" name="ipv4" required placeholder="10.10.10.2" autocomplete="off"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700
                               focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-shadow">
                </div>

                <!-- IPv6 -->
                <div class="mb-5">
                    <label class="block text-gray-700 text-sm font-bold mb-1" for="fieldIPv6">
                        IPv6 <span class="text-red-500">*</span>
                        <span class="font-normal text-gray-400 ml-1">(auto)</span>
                    </label>
                    <input type="text" id="fieldIPv6" name="ipv6" required placeholder="fd00:10:10::2"
                        autocomplete="off" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700
                               focus:outline-none focus:ring-2 focus:ring-indigo-300 transition-shadow">
                </div>

                <!-- Progress bar (linear, safe) -->
                <div id="addProgress" class="progress-bar-wrap mb-3">
                    <div id="addProgressInner" class="progress-bar-inner"></div>
                </div>

                <!-- Error -->
                <div id="modalError"
                    class="hidden bg-red-50 text-red-700 text-sm p-2 rounded mb-3 border border-red-100" role="alert">
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()"
                        class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded
                               flex items-center gap-2 transition-colors">
                        <i class="fas fa-plus" id="submitIcon"></i>
                        <span id="submitLabel">Create</span>
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- ══════════════════════════════════════════════════════════════════
         QR Code Modal — smooth fade, image fades in when loaded, NO flash
    ══════════════════════════════════════════════════════════════════ -->
    <div id="qrModal" class="modal-wrap fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true"
        aria-labelledby="qrModalTitle">

        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-600 bg-opacity-50" onclick="closeQrModal()"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>

            <div class="modal-box inline-block align-bottom bg-white rounded-lg overflow-hidden shadow-xl
                        sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">

                <!-- Loading state: dot-ellipsis + progress bar, NO spinner spin -->
                <div id="qrLoading" class="px-4 pt-8 pb-6 text-center">
                    <p class="text-gray-500 text-sm mb-4 dot-pulse">Generating config</p>
                    <div class="progress-bar-wrap active mx-auto" style="max-width:240px;">
                        <div id="qrProgressInner" class="progress-bar-inner"></div>
                    </div>
                </div>

                <!-- Content: hidden until config + image are ready -->
                <div id="qrContent" class="hidden">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 text-center">
                        <h3 id="qrModalTitle" class="text-lg font-medium text-gray-900 mb-1">Scan WireGuard Config</h3>
                        <p id="qrPeerName" class="text-sm text-gray-400 mb-4"></p>
                        <div class="flex justify-center">
                            <img id="qrImage" src="" alt="QR Code" class="border p-2 rounded max-w-xs">
                        </div>
                        <div class="mt-4">
                            <textarea id="configText" rows="10" readonly
                                class="w-full text-xs font-mono bg-gray-50 p-2 rounded border resize-none
                                       focus:outline-none focus:ring-2 focus:ring-indigo-200 transition-shadow"></textarea>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 flex justify-end gap-2">
                        <button onclick="copyConfig()"
                            class="inline-flex items-center gap-1 rounded-md border border-indigo-300 px-4 py-2
                                   bg-indigo-50 text-sm font-medium text-indigo-700 hover:bg-indigo-100 transition-colors">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button onclick="downloadConfigFromModal()"
                            class="inline-flex items-center gap-1 rounded-md border border-green-300 px-4 py-2
                                   bg-green-50 text-sm font-medium text-green-700 hover:bg-green-100 transition-colors">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button onclick="closeQrModal()" class="inline-flex items-center rounded-md border border-gray-300 px-4 py-2
                                   bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                            Close
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- ══════════════════════════════════════════════════════════════════
         JavaScript
    ══════════════════════════════════════════════════════════════════ -->
    <script>
        'use strict';

        // ─── State ────────────────────────────────────────────────────────────────
        let currentPeerName = '';
        let toastTimer = null;

        // ─── Toast (replaces ALL Swal alerts — zero flash) ────────────────────────
        function showToast(msg, type = 'info', duration = 3000) {
            const el = document.getElementById('toast');
            // Hide first (instant, already invisible if not showing)
            el.classList.remove('show');
            el.className = type; // reset class
            el.textContent = msg;
            clearTimeout(toastTimer);
            // Next frame: fade in
            requestAnimationFrame(() => {
                requestAnimationFrame(() => el.classList.add('show'));
            });
            toastTimer = setTimeout(() => el.classList.remove('show'), duration);
        }

        // ─── Progress bar: smooth linear fill, NO rotation ────────────────────────
        function startProgress(innerId, wrapId) {
            const wrap = document.getElementById(wrapId);
            const inner = document.getElementById(innerId);
            if (!wrap || !inner) return;
            // Reset instantly
            inner.style.transition = 'none';
            inner.style.width = '0%';
            wrap.classList.add('active');
            // Force reflow
            inner.getBoundingClientRect();
            // Animate to 82% slowly (will be completed on finish)
            inner.style.transition = 'width 2s cubic-bezier(0.08, 0.82, 0.17, 1)';
            inner.style.width = '82%';
        }

        function finishProgress(innerId, wrapId) {
            const wrap = document.getElementById(wrapId);
            const inner = document.getElementById(innerId);
            if (!inner) return;
            inner.style.transition = 'width 0.2s ease';
            inner.style.width = '100%';
            setTimeout(() => {
                if (wrap) wrap.classList.remove('active');
                inner.style.transition = 'none';
                inner.style.width = '0%';
            }, 280);
        }

        // ─── Modal open/close: smooth opacity transition, NO flash ────────────────
        function openModalEl(id) {
            const el = document.getElementById(id);
            requestAnimationFrame(() => {
                requestAnimationFrame(() => el.classList.add('visible'));
            });
        }

        function closeModalEl(id) {
            document.getElementById(id).classList.remove('visible');
        }

        // ─── Get peer data from row dataset ───────────────────────────────────────
        function getPeerData(id) {
            const row = document.getElementById('row-' + id);
            if (!row) return null;
            return {
                name: row.dataset.name,
                privkey: row.dataset.privkey,
                ipv4: row.dataset.ipv4,
                ipv6: row.dataset.ipv6,
                isActive: row.dataset.active === 'true'
            };
        }

        // ─── Validate peer can generate config ───────────────────────────────────
        function validatePeer(privkey, ipv6) {
            if (!privkey || privkey === 'null' || privkey === 'undefined') {
                showToast('Private key tidak ditemukan. Peer dibuat manual via Winbox.', 'error', 5000);
                return false;
            }
            if (!ipv6 || ipv6 === '-') {
                showToast('IPv6 tidak tersedia pada peer ini.', 'error', 5000);
                return false;
            }
            return true;
        }

        // ─── Trigger browser file download ───────────────────────────────────────
        function triggerDownload(name, text) {
            const filename = (name || 'wireguard').replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.conf';
            const a = document.createElement('a');
            a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // ─── Fetch config from server ─────────────────────────────────────────────
        async function fetchConfig(privkey, ipv4, ipv6) {
            const res = await fetch('/qrcode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ privkey, ipv4, ipv6 })
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }

        // ─── Download .conf directly from table row ───────────────────────────────
        async function downloadConfigDirect(id) {
            const peer = getPeerData(id);
            if (!peer || !validatePeer(peer.privkey, peer.ipv6)) return;

            const btn = document.getElementById('dl-' + id);
            if (btn) btn.classList.add('btn-loading');
            showToast('Menyiapkan download\u2026', 'info', 10000);

            try {
                const data = await fetchConfig(peer.privkey, peer.ipv4, peer.ipv6);
                if (data.success) {
                    triggerDownload(peer.name, data.configText);
                    showToast(`"${peer.name || 'Config'}" berhasil diunduh`, 'success');
                } else {
                    showToast(data.error || 'Gagal generate config', 'error', 5000);
                }
            } catch {
                showToast('Gagal menghubungi server', 'error', 5000);
            } finally {
                if (btn) btn.classList.remove('btn-loading');
            }
        }

        // ─── Download from QR modal ───────────────────────────────────────────────
        function downloadConfigFromModal() {
            const text = document.getElementById('configText').value;
            if (!text) return;
            triggerDownload(currentPeerName, text);
            showToast(`"${currentPeerName || 'Config'}" berhasil diunduh`, 'success');
        }

        // ─── Copy config to clipboard ─────────────────────────────────────────────
        function copyConfig() {
            const text = document.getElementById('configText').value;
            if (!text) return;
            navigator.clipboard.writeText(text)
                .then(() => showToast('Config disalin ke clipboard', 'success'))
                .catch(() => showToast('Gagal menyalin ke clipboard', 'error'));
        }

        // ─── Show QR Modal ────────────────────────────────────────────────────────
        async function showQR(id) {
            const peer = getPeerData(id);
            if (!peer || !validatePeer(peer.privkey, peer.ipv6)) return;

            currentPeerName = peer.name;

            // Reset state: show loading, hide content
            const loading = document.getElementById('qrLoading');
            const content = document.getElementById('qrContent');
            const img = document.getElementById('qrImage');

            loading.style.display = 'block';
            content.classList.add('hidden');
            img.classList.remove('loaded');
            img.src = '';

            openModalEl('qrModal');
            startProgress('qrProgressInner', 'qrLoading');

            try {
                const data = await fetchConfig(peer.privkey, peer.ipv4, peer.ipv6);

                if (!data.success) {
                    closeQrModal();
                    showToast(data.error || 'Gagal generate config', 'error', 5000);
                    return;
                }

                // Preload QR image before revealing
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = data.qrcode;
                });

                document.getElementById('configText').value = data.configText;
                document.getElementById('qrPeerName').textContent = peer.name || '';

                finishProgress('qrProgressInner', 'qrLoading');

                // Swap: hide loading, show content
                loading.style.display = 'none';
                content.classList.remove('hidden');
                // Image fade-in
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => img.classList.add('loaded'));
                });

            } catch {
                closeQrModal();
                showToast('Gagal menghubungi server', 'error', 5000);
            }
        }

        // ─── Open Add Peer Modal ──────────────────────────────────────────────────
        async function openModal() {
            document.getElementById('addForm').reset();
            hideModalError();
            resetSubmitBtn();
            openModalEl('addModal');
            await fetchSuggest();
        }

        // ─── Close Add Peer Modal ─────────────────────────────────────────────────
        function closeModal() {
            closeModalEl('addModal');
        }

        // ─── Close QR Modal ───────────────────────────────────────────────────────
        function closeQrModal() {
            closeModalEl('qrModal');
            // Clear stale data after transition ends
            setTimeout(() => {
                const img = document.getElementById('qrImage');
                img.src = '';
                img.classList.remove('loaded');
                document.getElementById('configText').value = '';
                document.getElementById('qrPeerName').textContent = '';
                currentPeerName = '';
                // Re-show loading state for next open
                document.getElementById('qrLoading').style.display = 'block';
                document.getElementById('qrContent').classList.add('hidden');
            }, 250);
        }

        // Backdrop click closes modal
        function handleModalBackdrop(e) {
            if (e.target === document.getElementById('addModal')) closeModal();
        }

        // Escape key closes whichever modal is open
        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            if (document.getElementById('qrModal').classList.contains('visible')) closeQrModal();
            if (document.getElementById('addModal').classList.contains('visible')) closeModal();
        });

        // ─── Fetch autosuggest ────────────────────────────────────────────────────
        async function fetchSuggest() {
            const regenBtn = document.getElementById('regenBtn');
            const regenLabel = document.getElementById('regenLabel');
            regenBtn.disabled = true;
            regenBtn.classList.add('btn-loading');
            regenLabel.textContent = 'Loading\u2026';

            try {
                const res = await fetch('/suggest');
                if (!res.ok) throw new Error('Network error');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('fieldName').value = data.name;
                    document.getElementById('fieldIPv4').value = data.ipv4;
                    document.getElementById('fieldIPv6').value = data.ipv6;
                    hideModalError();
                } else {
                    throw new Error(data.error || 'Suggest failed');
                }
            } catch {
                // Silent fail — user can fill manually
            } finally {
                regenBtn.disabled = false;
                regenBtn.classList.remove('btn-loading');
                regenLabel.textContent = 'Regenerate';
            }
        }

        // ─── Submit Add Peer ──────────────────────────────────────────────────────
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideModalError();

            const data = Object.fromEntries(new FormData(e.target).entries());

            if (!data.name?.trim()) { showModalError('Nama peer tidak boleh kosong'); return; }
            if (!data.ipv4?.trim()) { showModalError('IPv4 tidak boleh kosong'); return; }
            if (!data.ipv6?.includes(':')) { showModalError('IPv6 tidak valid — harus mengandung ":"'); return; }

            setSubmitLoading(true);
            startProgress('addProgressInner', 'addProgress');

            try {
                const res = await fetch('/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();

                if (json.success) {
                    finishProgress('addProgressInner', 'addProgress');
                    closeModal();

                    // Inject row into DOM — NO page reload = NO flash
                    if (json.peer) {
                        injectPeerRow(json.peer);
                        showToast(`Peer "${data.name}" berhasil ditambahkan`, 'success');
                    } else {
                        // Fallback if server doesn't return peer object
                        window.location.reload();
                    }
                } else {
                    finishProgress('addProgressInner', 'addProgress');
                    showModalError(json.error || 'Gagal menambah peer');
                    setSubmitLoading(false);
                }
            } catch {
                finishProgress('addProgressInner', 'addProgress');
                showModalError('Request gagal, cek koneksi');
                setSubmitLoading(false);
            }
        });

        // ─── Inject new peer row into table (no reload, no flash) ─────────────────
        function injectPeerRow(peer) {
            const tbody = document.getElementById('peersTableBody');
            const emptyMsg = document.getElementById('emptyMsg');
            if (emptyMsg) emptyMsg.remove();

            const hasPk = peer.privkey && peer.privkey !== 'null' && peer.privkey !== 'undefined';
            const hasIpv6 = peer.ipv6 && peer.ipv6 !== '-';
            const canConfig = hasPk && hasIpv6;

            const dlClass = canConfig
                ? 'text-green-600 hover:text-green-800 hover:bg-green-100 bg-green-50'
                : 'text-gray-300 bg-gray-50 cursor-not-allowed';
            const qrClass = canConfig
                ? 'text-indigo-600 hover:text-indigo-800 hover:bg-indigo-100 bg-indigo-50'
                : 'text-gray-300 bg-gray-50 cursor-not-allowed';

            const pid = peer['.id'];

            const tr = document.createElement('tr');
            tr.id = 'row-' + pid;
            tr.dataset.active = peer.disabled === 'false' ? 'true' : 'false';
            tr.dataset.name = peer.name || '';
            tr.dataset.privkey = peer.privkey || '';
            tr.dataset.ipv4 = peer.ipv4 || '';
            tr.dataset.ipv6 = peer.ipv6 || '';
            tr.className = 'hover:bg-gray-50 transition-colors';

            // Fade-in via opacity transition
            tr.style.opacity = '0';
            tr.style.transition = 'opacity 0.3s ease';

            const isActive = tr.dataset.active === 'true';

            tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <button onclick="togglePeer(this, '${pid}')" id="toggle-${pid}"
                    aria-pressed="${isActive}"
                    class="toggle-btn relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer focus:outline-none focus:ring-2 focus:ring-indigo-400 ${isActive ? 'bg-green-500' : 'bg-gray-200'}">
                    <span class="toggle-knob pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow ring-0 ${isActive ? 'translate-x-5' : 'translate-x-0'}"></span>
                </button>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${escHtml(peer.name || '(no name)')}</div>
                <div class="text-xs text-gray-400">PK: ${escHtml((peer['public-key'] || '').substring(0, 8))}&hellip;</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-700">${escHtml(peer.ipv4 || '')}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">${escHtml(peer.ipv6 || '')}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <div><i class="fas fa-arrow-up text-green-500 mr-1"></i>0.00 MB</div>
                <div><i class="fas fa-arrow-down text-blue-500 mr-1"></i>0.00 MB</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="inline-flex items-center gap-2">
                    <button id="dl-${pid}"
                        onclick="${canConfig ? `downloadConfigDirect('${pid}')` : 'return false'}"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors ${dlClass}">
                        <i class="fas fa-download text-sm"></i>
                    </button>
                    <button id="qr-${pid}"
                        onclick="${canConfig ? `showQR('${pid}')` : 'return false'}"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors ${qrClass}">
                        <i class="fas fa-qrcode text-sm"></i>
                    </button>
                    <button id="del-${pid}" onclick="deletePeer('${pid}')"
                        class="inline-flex items-center justify-center w-8 h-8 rounded-full transition-colors text-red-500 hover:text-red-700 hover:bg-red-100 bg-red-50">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            </td>
        `;

            tbody.appendChild(tr);
            updateCounters();

            // Trigger fade-in after appended to DOM
            requestAnimationFrame(() => {
                requestAnimationFrame(() => { tr.style.opacity = '1'; });
            });
        }

        // ─── Escape HTML to prevent XSS in injected rows ──────────────────────────
        function escHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ─── Submit button state ───────────────────────────────────────────────────
        function setSubmitLoading(on) {
            const btn = document.getElementById('submitBtn');
            const icon = document.getElementById('submitIcon');
            const label = document.getElementById('submitLabel');
            if (on) {
                btn.disabled = true;
                btn.classList.add('btn-loading');
                icon.className = 'fas fa-circle-notch';  // static icon, NO fa-spin
                label.className = 'dot-pulse';
                label.textContent = 'Creating';
            } else {
                resetSubmitBtn();
            }
        }

        function resetSubmitBtn() {
            const btn = document.getElementById('submitBtn');
            const icon = document.getElementById('submitIcon');
            const label = document.getElementById('submitLabel');
            btn.disabled = false;
            btn.classList.remove('btn-loading');
            icon.className = 'fas fa-plus';
            label.className = '';
            label.textContent = 'Create';
        }

        // ─── Modal error ───────────────────────────────────────────────────────────
        function showModalError(msg) {
            const el = document.getElementById('modalError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideModalError() {
            document.getElementById('modalError').classList.add('hidden');
        }

        // ─── Toggle Peer ──────────────────────────────────────────────────────────
        async function togglePeer(btn, id) {
            const row = document.getElementById('row-' + id);
            if (!btn || !row) return;

            const isActive = row.dataset.active === 'true';
            btn.disabled = true;
            btn.style.opacity = '0.55';

            try {
                const res = await fetch('/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, enabled: isActive })
                });
                const json = await res.json();

                if (json.success) {
                    const nowActive = !isActive;
                    row.dataset.active = nowActive;
                    btn.setAttribute('aria-pressed', nowActive);

                    const knob = btn.querySelector('span');
                    if (nowActive) {
                        btn.classList.replace('bg-gray-200', 'bg-green-500');
                        knob.classList.replace('translate-x-0', 'translate-x-5');
                    } else {
                        btn.classList.replace('bg-green-500', 'bg-gray-200');
                        knob.classList.replace('translate-x-5', 'translate-x-0');
                    }
                    updateCounters();
                } else {
                    showToast(json.error || 'Gagal toggle peer', 'error', 4000);
                }
            } catch {
                showToast('Gagal toggle peer', 'error', 4000);
            } finally {
                btn.disabled = false;
                btn.style.opacity = '1';
            }
        }

        // ─── Delete Peer ──────────────────────────────────────────────────────────
        async function deletePeer(id) {
            const peer = getPeerData(id);
            const name = peer?.name || 'peer ini';

            // Swal confirm — all animations disabled to prevent flash
            const result = await Swal.fire({
                title: `Hapus "${name}"?`,
                text: 'Tidak bisa di-undo!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonText: 'Batal',
                confirmButtonText: 'Ya, hapus!',
                showClass: { popup: '', backdrop: '', icon: '' },
                hideClass: { popup: '', backdrop: '', icon: '' },
            });
            if (!result.isConfirmed) return;

            const row = document.getElementById('row-' + id);
            const btn = document.getElementById('del-' + id);

            if (btn) btn.classList.add('btn-loading');

            try {
                const res = await fetch('/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                const json = await res.json();

                if (json.success) {
                    showToast(`Peer "${name}" dihapus`, 'success');
                    if (row) {
                        // Smooth CSS transition exit — NO keyframe animation flash
                        row.classList.add('row-removing');
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => row.classList.add('out'));
                        });
                        row.addEventListener('transitionend', () => {
                            row.remove();
                            updateCounters();
                            checkEmptyTable();
                        }, { once: true });
                    }
                } else {
                    showToast(json.error || 'Gagal hapus peer', 'error', 5000);
                    if (btn) btn.classList.remove('btn-loading');
                }
            } catch {
                showToast('Gagal hapus peer', 'error', 5000);
                if (btn) btn.classList.remove('btn-loading');
            }
        }

        // ─── Update counters ──────────────────────────────────────────────────────
        function updateCounters() {
            const rows = document.querySelectorAll('#peersTableBody tr[data-active]');
            const total = rows.length;
            const active = [...rows].filter(r => r.dataset.active === 'true').length;
            document.querySelectorAll('.counter-total').forEach(el => el.textContent = total);
            document.querySelectorAll('.counter-active').forEach(el => el.textContent = active);
        }

        // ─── Show empty message if table is empty ─────────────────────────────────
        function checkEmptyTable() {
            const tbody = document.getElementById('peersTableBody');
            if (!tbody || tbody.querySelectorAll('tr').length > 0) return;
            if (document.getElementById('emptyMsg')) return;
            const container = document.querySelector('.bg-white.shadow-md');
            if (!container) return;
            const msg = document.createElement('div');
            msg.id = 'emptyMsg';
            msg.className = 'p-8 text-center text-gray-500';
            msg.textContent = 'No peers found.';
            container.appendChild(msg);
        }

    </script>

</body>

</html>